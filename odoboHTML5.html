<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Odobo</title>
</head>
<body>

<script type="text/javascript" src="utils.js"></script>

<script type="text/javascript" src="2D/geom.js"></script>
<script type="text/javascript" src="2D/pixel.js"></script>
<script type="text/javascript" src="2D/videobuff.js"></script>
<script type="text/javascript" src="2D/line.js"></script>
<script type="text/javascript" src="2D/viewer.js"></script>

<script type="text/javascript" src="3D/global.js"></script>
<script type="text/javascript" src="3D/vector.js"></script>
<script type="text/javascript" src="3D/poly.js"></script>
<script type="text/javascript" src="3D/camera.js"></script>
<script type="text/javascript" src="3D/renderer.js"></script>
<script type="text/javascript" src="3D/obj.js"></script>
<script type="text/javascript" src="3D/engine.js"></script>

<script type="text/javascript">
    
    var gEngine;
    function odobo_Init()
    {
        var width, height;
        var bgColor;

        width = 640/2;
        height = 480/2;

        gEngine = engine_Create( VIEWER_TYPE_HTML5, width, height );

        gEngine.viewer.canvas.style.border = '1px solid black';
        gEngine.viewer.canvas.style.position = 'absolute';
        gEngine.viewer.canvas.style.top = (window.innerHeight/2-height/2) + 'px';
        gEngine.viewer.canvas.style.left = (window.innerWidth/2-width/2) + 'px';

        engine_InitObjects( gEngine );

        document.body.appendChild( gEngine.viewer.canvas );
    }
    odobo_Init();


    var gAngle = 0.0;
    function odobo_Run()
    {
        var i;
        videobuff_Clear( gEngine.videobuff );

        camera_Euler( gEngine.camera );
        renderer_Reset( gEngine.rlist );

        for ( i = 0; i < gEngine.objectsArr.length; i++ )
        {
            var obj = gEngine.objectsArr[i];
            if ( (obj.state&STATE_ON) != STATE_ON ) continue;
            if (renderer_CameraCull(gEngine.rlist, obj, gEngine.camera) == 1)
                renderer_AddObject(gEngine.rlist, obj, gEngine.camera);
        } // end for i

        renderer_Render( gEngine.rlist, gEngine.videobuff, gEngine.camera );
        engine_Draw( gEngine.viewer, gEngine.videobuff );

    }
    function odobo_FnAI()
    {
        alert( 'odobo_FnAI not implemented');
        return 0;
    }

</script>

<div id="msgPanel" style="overflow-y: scroll; float: right; width: 250px; height: 80px; border: 1px solid black; padding: 2px;"></div>
<script type="text/javascript">
    function odobo_AddMsgToPanel( msg )
    {
        var div = document.createElement('div');
        div.style.color = 'green';
        div.appendChild( document.createTextNode( msg ) );
        document.getElementById('msgPanel').appendChild(div);
        setTimeout( function()
        {
            document.getElementById('msgPanel').removeChild( div );
        }, 3000 );
    }
    function odobo_ResetObjects()
    {
        var i;
        for ( i = 0; i < gEngine.numObjects; i++ )
        {
            gEngine.objectsArr[i].state = 0;
            gEngine.objectsArr[i].attr = 0;
            gEngine.objectsArr[i].matrix = mat4x3_CreateIdentity();
        }
    }
</script>

<fieldset style="width:150px; font-size: 10px;">
    <legend>Tests:</legend>
    <script type="text/javascript">
        var SPINNER_STATE_INIT = 0;
        var SPINNER_STATE_WORKING = 1;
        var SPINNER_STATE_STOP = 2;
        var gOdoboSpinner;
        function odoboSpinner_Create()
        {
            var i;
            gOdoboSpinner = {
                state: SPINNER_STATE_INIT,
                animation: 1,
                framesCounter: 0,
                angle: 0.0,
                spinSpeed: 0,
                center: null,
                z: 500
            };

            odobo_ResetObjects();
            var h = 0;
            var rows, cols;
            i = 0;
            var color;
            for ( i = 0; i < gEngine.numObjects; i++ )
            {
                gEngine.objectsArr[i].state = STATE_ON;
                gEngine.objectsArr[i].attr = ATTR_2SIDE | ATTR_WIRED;
                if ( i >= 0 && 5 > i )
                    color = gPixelRed;
                if ( i >= 5 && 10 > i )
                    color = gPixelGreen;
                if ( i >= 10 && 15 > i )
                    color = gPixelBlue;

                gEngine.objectsArr[i].color = color;


            } // end for i


//            gEngine.objectsArr[i].color = gPixelRed;

        }
        odoboSpinner_Create();
        function odobo_Spinner()
        {
            if ( gOdoboSpinner.framesCounter++ > 1000 ) return 0;

            var i;
            var start = -200;
            var x = start;
            var y = start;
            var step = 100;
            for ( i = 0; i < gEngine.numObjects; i++ )
            {
                gEngine.objectsArr[i].matrix = mat4x3_RotXX( gOdoboSpinner.angle );
                gEngine.objectsArr[i].matrix.tx = x;
                gEngine.objectsArr[i].matrix.ty = y;
                x += step;
                if ( (i+1) % 5 == 0 )
                {
                    x = start;
                    y += step;
                }

                gEngine.objectsArr[i].matrix.tz = gOdoboSpinner.z;
            } // end for i

            if ( gOdoboSpinner.framesCounter > 0 )
                gOdoboSpinner.angle += 0.1;
            if ( gOdoboSpinner.framesCounter > 100 )
                gOdoboSpinner.angle += 0.1;
            if ( gOdoboSpinner.framesCounter > 400 )
                gOdoboSpinner.angle -= 0.1;
            if ( gOdoboSpinner.framesCounter > 600 )
                gOdoboSpinner.angle -= 0.1;

            return 1;
        }

    </script>
    <input type="radio" name="viewerTest" onclick="odobo_AddMsgToPanel( 'Odobo spinner' ); odoboSpinner_Create(); odobo_FnAI = odobo_Spinner;"> Odobo spinner

    <script type="text/javascript">
        var testQuadsCounter = 0;
        var testQuadsAngle0 = 0;
        var testQuadsAngle1 = 0;
        function odobo_TestQuads1()
        {
            var angle = 0.1;
            if ( testQuadsCounter++ == 10000 ) return 0;

            odobo_ResetObjects();

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].matrix = mat4x3_RotXX( testQuadsAngle0 );
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].matrix = mat4x3_RotYY( testQuadsAngle0 );
            gEngine.objectsArr[gEngine.OBJ_QUAD_2].matrix = mat4x3_RotZZ( testQuadsAngle0 );

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].color = gPixelRed;
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].color = gPixelGreen;
            gEngine.objectsArr[gEngine.OBJ_QUAD_2].color = gPixelBlue;

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].state |= STATE_ON;
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].state |= STATE_ON;
//            gEngine.objectsArr[gEngine.OBJ_QUAD_2].state |= STATE_ON;

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr |= ATTR_2SIDE;
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].attr |= ATTR_2SIDE;
            gEngine.objectsArr[gEngine.OBJ_QUAD_2].attr |= ATTR_2SIDE;

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr |= ATTR_WIRED;
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].attr |= ATTR_WIRED;
            gEngine.objectsArr[gEngine.OBJ_QUAD_2].attr |= ATTR_WIRED;

            testQuadsAngle0 += angle;

            return 1;
        }
    </script>
    <br>
    <input type="radio" name="viewerTest" onclick="odobo_AddMsgToPanel( 'Quads' ); odobo_FnAI = odobo_TestQuads1;"> Quads

    <script type="text/javascript">
        function odobo_TestQuadsBackFaceCulling()
        {
            var res = odobo_TestQuads1();
            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr &= ~ATTR_2SIDE;
            gEngine.objectsArr[gEngine.OBJ_QUAD_1].attr &= ~ATTR_2SIDE;
            gEngine.objectsArr[gEngine.OBJ_QUAD_2].attr &= ~ATTR_2SIDE;
            return res;
        }
    </script>
    <br>
    <input type="radio" name="viewerTest" onclick="odobo_AddMsgToPanel( 'Quads back face culling' ); odobo_FnAI = odobo_TestQuadsBackFaceCulling;"> Quads back face culling
    <script type="text/javascript">
        function odobo_TestQuadsSolid()
        {
            odobo_ResetObjects();

            gEngine.objectsArr[gEngine.OBJ_QUAD_0].matrix = mat4x3_RotXX( 0 );
            gEngine.objectsArr[gEngine.OBJ_QUAD_0].state |= STATE_ON;
            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr |= ATTR_2SIDE;
            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr |= ATTR_WIRED;
            gEngine.objectsArr[gEngine.OBJ_QUAD_0].attr |= ATTR_SOLID;

            return 1;
        }
    </script>
    <br>
    <input type="radio" name="viewerTest" onclick="odobo_AddMsgToPanel( 'Quads solid' ); odobo_FnAI = odobo_TestQuadsSolid;"> Quads solid
    <br>
    <input type="radio" name="viewerTest" onclick="alert(1);"> Test zbuffer
</fieldset>

<script type="text/javascript">
    odobo_FnAI = odobo_TestQuads1;
    odobo_FnAI = odobo_Spinner;
//    odobo_FnAI = odobo_TestQuadsSolid;
    function odobo_Main()
    {
        if ( odobo_FnAI() == 0 ) return;
        odobo_Run();
        setTimeout( function() { odobo_Main(); }, 20 );
    }
    odobo_Main();
</script>

</body>
</html>