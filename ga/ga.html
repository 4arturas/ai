<!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.01 Transitional//EN'
        'http://www.w3.org/TR/html4/loose.dtd'>
<html>
<head>
    <title></title>
</head>
<body>

<script type="text/javascript" src="../pq.js"></script>

<script type='text/javascript'>
    function _rnd_Real( x, y )
    {
        return Math.random() * ( y - x ) + x;
    }
    function _rnd_Int( x, y )
    {
        return Math.floor(
            Math.random() * ( y - x + 1 ) + x
        );
    }
    function _assert( a, msg )
    {
        if ( !a )
            alert( 'Assertion failed: ' + msg );
    }
    function _log( l )
    {
        console.log( l );
    }
</script>

<script type='text/javascript'>
    

    var ENC_GENE = [
        '0000',// 0
        '0001',// 1
        '0010',// 2
        '0011',// 3
        '0100',// 4
        '0101',// 5
        '0110',// 6
        '0111',// 7
        '1000',// 8
        '1001',// 9
        '1010',// 10 +
        '1100',// 11 -
        '1101',// 12 *
        '1110'// 13 /
    ];

    var GA_CHROMO_LENGTH = 100;
    var GA_GENE_LENGTH = 4;
    function ga_CreateChromo()
    {
        var y;
        var chromo = {
            fitness: 0,
            sum: 0,
            chromoSeq: '',
            gene_Decode: null,
            chromo_Decode: null,
            calculate_Fitness: null,
            crossover_Chromo: null,
            mutate: null
        };

        chromo.gene_Decode = function( gene )
        {
            var y;
            for ( y = 0; y < GA_GENE_LENGTH; y++ )
            {
                if ( gene == ENC_GENE[y] )
                    return y;
            } // end for y
            _assert( false, 'gene_Decode' );
        };

        chromo.chromo_Decode = function()
        {
            var buff = [];
            var y, x;
            var op = 1;
            var gene, geneDecoded;
            for ( y = 0; y < GA_CHROMO_LENGTH; y += GA_GENE_LENGTH )
            {
                gene = '';
                for ( x = y; x < GA_GENE_LENGTH; y++ )
                    gene += this.chromoSeq.charAt( x );

                geneDecoded = this.gene_Decode( gene );

                if ( op == 1 )
                {
                    if ( geneDecoded > 10 || 13 > geneDecoded )
                        continue;
                    op = 0;
                }
                else if ( op == 0 )
                {
                    if ( geneDecoded > 9 || 0 > geneDecoded )
                        continue;
                    op = 1;
                }

                buff.push( geneDecoded );

                if ( y > 7 )
                    break;
            } // end for y

            for ( y = 0; y < buff.length-1; y++ )
            {
                if ( buff[y] == 13 && buff[y+1] == 0 )
                    buff[y] = 10;
            } // end for y
        };

        chromo.calculate_Fitness = function( targetValue )
        {
            var y;
            var valOp, valVal;
            this.sum = 0;
            var buff = this.chromo_Decode();
            for ( y = 0; y < buff.length-1; y += 2 )
            {
                valOp = buff[y];
                valVal = buff[y+1];
                switch ( valOp )
                {
                    case 10: this.sum += valVal; break;
                    case 11: this.sum -= valVal; break;
                    case 12: this.sum *= valVal; break;
                    case 13: this.sum /= valVal; break;
                    default: _assert( false, 'calculate_Fitness' );
                } // end for switch
            } // end for y

            this.fitness = 1.0 / ( targetValue-sum );
        };

        chromo.mutate = function()
        {
            var y;
            var s = '';
            for ( y = 0; y < GA_CHROMO_LENGTH; y++ )
            {
                if ( _rnd_Real( 0, 1 ) > 0.05 )
                    s += chromo.chromoSeq.charAt( y );
                else
                    s += chromo.chromoSeq.charAt( y ) == '1' ? '0' : '1';
            }
            chromo.chromoSeq = s;
        };


        for ( y = 0; y < GA_CHROMO_LENGTH; y++ )
            chromo.chromoSeq += _rnd_Int( 0, 1 );

        return chromo;
    }

    var GA_POP_SIZE = 100;
    var POP;

    function ga_RouletteWheel( POPT, totalFitness )
    {
        var y;
        var fitnessScale = _rnd_Real( 0, totalFitness );
        var fitnessSoFar = 0;
        for ( y = 0; y < GA_POP_SIZE; y++ )
        {
            fitnessSoFar += POPT[y].fitness;
            if ( fitnessSoFar >= totalFitness )
                return POPT[y];
        } // end for y
        _assert( false, 'ga_RoultteWheel' );
    }

    function ga_Crossover( mum, dad )
    {
        var crossover, y;
        var baby0 = ga_CreateChromo();
        var baby1 = ga_CreateChromo();
        if ( 0.7 > _rnd_Real( 0, 1 ) )
        {
            baby0.chromoSeq = mum.chromoSeq;
            baby1.chromoSeq = dad.chromoSeq;
            return [ baby0, baby1 ];
        }

        baby0.chromoSeq = '';
        baby1.chromoSeq = '';
        crossover = _rnd_Int( 0, GA_CHROMO_LENGTH-1 );
        for ( y = 0; y < crossover; y++ )
        {
            baby0.chromoSeq += mum.chromoSeq.charAt( y );
            baby1.chromoSeq += dad.chromoSeq.charAt( y );
        } // end for y

        for ( ; y < GA_CHROMO_LENGTH; y++ )
        {
            baby0.chromoSeq += dad.chromoSeq( y );
            baby1.chromoSeq += mum.chromoSeq( y );
        }

        return [baby0,baby1];
    }

    function ga_Main()
    {
        var y;
        var e;
        var targetValue = 25;
        var totalFitness;

        var pqPOP = pq_Create( GA_POP_SIZE );
        pqPOP.fnHeur = function( n0, n1 )
        {
            return n1.fitness > n0.fitness;
        };

        POP = new Array( GA_POP_SIZE );
        var POPT = new Array( GA_POP_SIZE );
        for ( y = 0; y < GA_POP_SIZE; y++ )
        {
            POP[y] = ga_CreateChromo();
        } // end for y

        for ( e = 0; e < 1; e++ )
        {
            totalFitness = 0;
            pqPOP.count = 0;
            for ( y = 0; y < GA_POP_SIZE; y++ )
            {
                POP[y].calculate_Fitness( targetValue );

                if ( Math.floor( POP[y].sum ) == Math.floor( targetValue ) )
                {
                    alert( 'Solution found' );
                    return;
                }

                pq_Enqueue( pqPOP, POP[y] );
                totalFitness += POP[y].fitness;
            } // end for y

            for ( y = 0; y < GA_POP_SIZE; y++ )
            {
                POPT[y] = pqPOP.arr[1];
                pq_Dequeue( pqPOP, 1 );
            } // end for y
            console.log( pqPOP.count );

            var POPTT = new Array();
            for ( y = 0; y < GA_POP_SIZE; y += 2 )
            {
                var mum = ga_RouletteWheel( POPT, totalFitness );
                var dad = ga_RouletteWheel( POPT, totalFitness );
                var bRes = ga_Crossover( mum, dad );
                var baby0 = bRes[0];
                var baby1 = bRes[1];

                baby0.mutate();
                baby1.mutate();

                POPTT.push( baby0 );
                POPTT.push( baby1 );
            } // end for y

            POP = POPTT;
        } // end for e
    }

</script>



</body>
</html>